---
date: 2025-03-28
title: C语言内存管理
category: c语言
tags:
  - c
description: 在c语言中内存分配包括静态和动态两种类型，本文是各种内存申请方式的详细介绍（DS）
---
# 内存的分配
::: info 内存分配的类型
分为三种：静态内存、栈内存(数组的静态分配)、堆内存(动态内存分配)
:::

#### **1. 静态内存分配**
- **定义**：在编译时确定大小和位置，生命周期与程序一致。
    - **特点**：
        - 存放全局变量、静态变量、常量。
        - 无需手动管理，由系统自动分配和释放。
- **内存区域**：
    - **数据段（Data Segment）**：存放已初始化的全局变量和静态变量。
	- **BSS段（Block Started by Symbol）**：存放未初始化的全局变量和静态变量（默认初始化为0）。
    - **代码段（Text Segment）**：存放程序代码和常量（如字符串常量）。

```c
int global_var = 10;                  // 数据段（.data）
static int static_var = 20;           // 数据段（.data）
int initialized_array[3] = {1, 2, 3}; // 数据段（.data）
int uninitialized_array[5];           // .bss 段（初始化为0）
char *str = "Hello";                  // 代码段（.rodata，只读）

void func() {
    static int local_static;          // BSS段（.bss）
}
```

#### **2. 栈内存分配**

- **定义**：由编译器自动管理，存放函数内的**局部变量**和参数。
- **特点**：
    - 内存分配和释放自动完成（函数调用时分配，返回时释放）。
    - 大小固定且有限（默认1-8MB，超出导致栈溢出）。
    
```c
void func() {
    int a = 10;       // 栈内存分配
    char buffer[100]; // 栈内存分配（注意避免过大）
}
```

#### **3. 堆内存分配**

- **定义**：由程序员手动管理的内存区域，用于动态分配。    
- **特点**：    
    - 内存大小可在运行时动态调整。        
    - 需显式分配（`malloc`/`calloc`）和释放（`free`）。        
    - 内存泄漏风险高，需谨慎管理。        
- **示例**：
    
```c
int *arr = (int*)malloc(10 * sizeof(int)); // 堆内存分配
free(arr); // 必须手动释放
```

# 变量作用域、生命周期、链接属性和存储类型

| 变量类型 | 声明的位置   | 是否存于堆栈 | 作用域      | 生命周期                        | 如果声明为static                |
| ---- | ------- | ------ | -------- | --------------------------- | -------------------------- |
| 全局   | 所有代码块之外 | 否      | 从声明处到文件尾 | 整个程序执行期间                    | 不允许其他源文件访问                 |
| 局部   | 代码块起始处  | 是      | 整个代码块    | 在代码块活动期间，一旦程序离开代码段，该变量的值即消失 | 变量不存储于堆栈中，它的值整个持程序执行期间一直保持 |
| 形式参数 | 函数头部    | 是      | 整个函数     |                             | 不允许                        |

---

# 数组
## 全局数组的「使用注意事项」

#### **（1）避免重复定义**

- 在多文件项目中，全局数组的**定义**只能出现一次，其他文件需用 `extern` 声明：
```c
	// file1.c
    int global_array[10];      // 定义
    
    // file2.c
    extern int global_array[]; // 声明（无需指定大小）
```

#### **2）谨慎使用 `static`**

- 使用 `static` 可限制全局数组的作用域，避免命名冲突：
```c
    // file1.c
    static int local_array[10]; // 仅当前文件可见
```

#### **（3）大小必须为常量表达式**

- 全局数组的大小必须在编译时确定（C89/C99均要求）：
```c
	#define SIZE 100
    int valid_array[SIZE];     // 合法（SIZE是宏常量）
    
    int size = 100;
    int invalid_array[size];   // 错误！全局数组不能用变量作为大小
    
```
  
#### **（4）避免过度使用全局数组**
- 全局数组会占用静态内存，可能导致可执行文件体积增大。
- 过度使用会增加程序的耦合性，建议优先使用局部变量或动态内存。

---

## 全局数组 vs. 局部数组

|**特性**|**全局数组**|**局部数组**|
|---|---|---|
|**存储位置**|数据段（.data / .bss）|栈（Stack）|
|**生命周期**|程序运行全程|函数调用期间|
|**初始化**|默认初始化为0（.bss）或指定值（.data）|未初始化时值为随机数|
|**作用域**|全局（或文件内 static）|函数内部|
|**大小确定**|必须为常量表达式|可为变量（C99 变长数组，但需谨慎）|